# Автоматическое обновление ИБ из репозитория в формате EDT

Скрипт позволяет автоматически обновлять информационные базы (ИБ) из репозиториев, сохранённых в формате EDT.

Скрипт написан на **OneScript**. Для его работы требуются следующие библиотеки: [v8runner](https://github.com/oscript-library/v8runner), [irac](https://github.com/arkuznetsov/irac), [cmdline](https://github.com/oscript-library/cmdline), [1commands](https://github.com/artbear/1commands), [json](https://github.com/oscript-library/json), [gitrunner](https://github.com/nixel2007/gitrunner).
Либо можно скачать архив со всеми необходимыми библиотеками ([lib.zip](https://github.com/user-attachments/files/22323381/lib.zip)).

Скрипт поддерживает обновление как с полным циклом (блокировка, ожидание окончания блокировки, разблокировка), что может быть полезно при обновлении stage баз (для тестирования и т.д.), так и частичное обновление (без блокировок и без выгрузки в XML).

Перед запуском необходимо настроить файл `updatesettings.json`. Он должен всегда находиться в папке со скриптом.

## Разделы файла настроек

### GIT

- `BranchName` — имя ветки, из которой необходимо производить обновление (необязательный параметр; если значение пустое, его нужно будет ввести вручную)
- `AccessToken` — токен доступа для авторизации в репозитории
- `UseSSH` — использовать SSH-подключение (при значении `true` токен не требуется)
- `RepoURL` — ссылка на репозиторий (используйте https- или ssh-путь)

### Database1C

- `ServerName` — имя сервера
- `ServerPort` — порт сервера (по умолчанию 1540)
- `RASPort` — порт подключения RAS (по умолчанию 1545)
- `BaseName` — имя ИБ
- `AdminLogin` — логин администратора ИБ
- `AdminPassword` — пароль администратора ИБ
- `AccessToken` — код доступа для блокировки ИБ
- `Version` — версия платформы ИБ
- `FileBaseDir` — путь к файловой базе (если указан, параметры `ServerName` и `ServerPort` игнорируются)
- `UpdateMode` — режим обновления базы (описание в конце блока)
- `BlockStartTime`/`BlockEndTime` — время начала/окончания блокировки (необязательные параметры; если не заполнены, потребуется ввести вручную)
- `BlockStartDate`/`BlockEndDate` — дата начала/окончания блокировки (необязательные параметры; если не заполнены, будут использоваться текущие даты)
- `UseDateBlockTime` — параметр, определяющий, запрашивать ли у пользователя дату блокировки, если она не заполнена (значения: `1` — да, `0` — нет)
- `FormatUpdate` — формат обновления (основная конфигурация или расширение; значения: `cf`, `cfu`)
- `ExtensionName` — имя расширения (указывать, если выбран формат `cfu`)

#### Режимы обновления (UpdateMode)

| Режим | Описание |
| :--- | :--- |
| **1** | Полное обновление (обновление репозитория, выгрузка в формат XML Конфигуратора, блокировка/разблокировка ИБ, обновление ИБ) |
| **2** | Обновление без блокировки (обновление репозитория, выгрузка в формат XML Конфигуратора, обновление ИБ) |
| **3** | Только обновление ИБ (аналог F7 в Конфигураторе) |

### FileLocations

Следующие параметры необязательны (кроме отмеченных). Если значение не указано, будет создана подпапка в каталоге скрипта.

- `EdtProjectDir` — путь к проекту EDT
- `XMLFilesDir` — путь для сохранения файлов в формате XML Конфигуратора (не очищается автоматически)
- `RepoDir` — путь к локальной копии репозитория
- `DirEDTCLI` — путь до 1cedtcli, если не заполнен, то будет использоваться стандартный вызов 1cedtcli в cmd 
- `SRCCFolder` — **обязательный параметр**: имя подпапки с проектом, из которой будут выгружены файлы
